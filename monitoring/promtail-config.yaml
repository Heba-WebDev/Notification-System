server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Collect logs from NestJS application containers only
  - job_name: nestjs-services
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    # Only read logs from the last 7 days to avoid old log issues
    target_config:
      sync_period: 10s
    relabel_configs:
      # Extract container name
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
        regex: '/(.*)'
        replacement: '${1}'
      # Extract service name from container name (notification-*)
      - source_labels: ['__meta_docker_container_name']
        target_label: 'service'
        regex: 'notification-(.*)'
        replacement: '${1}'
      # Add job label
      - target_label: 'job'
        replacement: 'nestjs-logs'
      # Add environment label
      - target_label: 'environment'
        replacement: 'production'
      # ONLY keep NestJS service containers (exclude infrastructure)
      - source_labels: ['__meta_docker_container_name']
        regex: 'notification-(api-gateway|auth-service|user-service|template-service|email-service|push-service)'
        action: keep
      # Drop infrastructure containers
      - source_labels: ['__meta_docker_container_name']
        regex: 'notification-(rabbitmq|postgres|redis|loki|promtail|grafana)'
        action: drop

    pipeline_stages:
      # Extract the actual log message from Docker JSON log format
      # Docker logs come as: {"log":"actual message\n","stream":"stdout","time":"..."}
      - json:
          expressions:
            output: log
            stream: stream
            time: time
      
      # Only process stdout/stderr streams
      - match:
          selector: '{stream=~"stdout|stderr"}'
          stages:
            - output:
                source: output
      
      # Filter out Docker system messages
      - drop:
          expression: '.*(docker|containerd|dockerd|Docker).*'
          drop_counter_reason: "docker_system_logs"
      
      # Filter out empty logs
      - drop:
          expression: '^\s*$'
          drop_counter_reason: "empty_logs"
      
      # Try to parse as JSON if application uses structured logging
      - json:
          expressions:
            level: level
            message: message
            timestamp: timestamp
            correlationId: correlationId
          drop_malformed: false
      
      # Extract log level from NestJS or console.log patterns
      - regex:
          expression: '(?i)\b(ERROR|WARN|WARNING|INFO|DEBUG|LOG|FATAL)\b'
          source: output
          target: 'detected_level'
      
      # Set log level label if detected
      - labels:
          level:
      
      # Parse timestamp from Docker log
      - timestamp:
          source: time
          format: RFC3339Nano
      
      # Add service name from container (already set in relabel_configs)
      # Add correlation ID if present
      - labels:
          correlationId:

